<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>🏀 Sniper J GM 模擬器 v0.9.0 Ultimate+</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    h1 { color: #2c3e50; }
    button { margin:5px; padding:10px; font-size:16px; border-radius:5px; cursor:pointer; background:#3498db; color:white; border:none; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    .player { background:white; margin:10px 0; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
    .player-info { flex-grow:1; }
    .progress-bar { width:100%; background:#ddd; height:8px; border-radius:4px; overflow:hidden; margin-top:4px; }
    .progress-bar-inner { height:100%; background:#4caf50; width:0%; }
    .section { margin-top:30px; }
    .container { max-width:900px; margin:auto; }
    label { display:block; margin:2px 0; }
    select, input[type=text] { padding:4px; margin:4px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏀 Sniper J GM 模擬器 v0.9.0 Ultimate+</h1>
    <div>
      <button id="clearBtn">清空存檔</button>
      <span id="dateDisplay"></span>
      <div id="moneyDisplay"></div>
    </div>
    <div class="section">
      <button id="showWarriorsBtn">勇士陣容</button>
      <button id="showFreeAgentsBtn">自由市場</button>
      <button id="showTradeBtn">交易中心</button>
      <button id="simulateGameBtn">模擬比賽</button>
      <button id="resetTrainingBtn">重置訓練</button>
    </div>
    <div id="teamContainer"></div>
    <div id="freeAgentContainer"></div>
    <div id="tradeContainer"></div>
    <div id="gameResult"></div>
  </div>

<script>
(() => {
  const ratingMap = {"C":1,"C+":2,"B-":3,"B":4,"B+":5,"A-":6,"A":7,"A+":8,"S":9,"S+":10};
  const order = ["C","C+","B-","B","B+","A-","A","A+","S","S+"];
  const ratingStars = r => "★".repeat(Math.min(5, Math.round(ratingMap[r]/2)));

  let warriors, freeAgents, otherTeams, money, salaryCap, lastDate, firstRoundPicks, trainLimit, todayTrained, currentTradeTarget;

  function defaultData(){
    return {
      warriors:[
        {name:"Stephen Curry",rating:"S",salary:35,trainProgress:0},
        {name:"Klay Thompson",rating:"B+",salary:20,trainProgress:0},
        {name:"Draymond Green",rating:"B",salary:18,trainProgress:0},
        {name:"Jonathan Kuminga",rating:"B",salary:15,trainProgress:0},
        {name:"Andrew Wiggins",rating:"B+",salary:22,trainProgress:0},
        {name:"Moses Moody",rating:"C+",salary:10,trainProgress:0},
        {name:"Gary Payton II",rating:"C+",salary:9,trainProgress:0},
        {name:"Brandin Podziemski",rating:"B-",salary:11,trainProgress:0},
        {name:"Kevon Looney",rating:"C",salary:8,trainProgress:0},
      ],
      freeAgents:[
        {name:"Malik Beasley",rating:"B",salary:15,signChance:60},
        {name:"Robert Covington",rating:"B-",salary:12,signChance:50},
        {name:"Dennis Smith Jr.",rating:"B-",salary:9,signChance:55},
        {name:"Justise Winslow",rating:"C+",salary:7,signChance:45},
        {name:"Tristan Thompson",rating:"C",salary:6,signChance:50},
      ],
      otherTeams:{
        "雷霆":[
          {name:"Shai Gilgeous‑Alexander",rating:"S",salary:34},
          {name:"Jalen Williams",rating:"A",salary:20},
          {name:"Chet Holmgren",rating:"A-",salary:18},
          {name:"Josh Giddey",rating:"B+",salary:16},
          {name:"Lu Dort",rating:"B",salary:14},
          {name:"Isaiah Joe",rating:"B-",salary:10}
        ],
        "金塊":[
          {name:"Nikola Jokic",rating:"S+",salary:38},
          {name:"Jamal Murray",rating:"A",salary:27},
          {name:"Aaron Gordon",rating:"B+",salary:24},
          {name:"Michael Porter Jr.",rating:"B+",salary:22},
          {name:"Kentavious Caldwell‑Pope",rating:"B",salary:15},
          {name:"Reggie Jackson",rating:"B-",salary:10}
        ]
      },
      money:100,
      salaryCap:120,
      lastDate:null,
      firstRoundPicks:{"勇士":2,"雷霆":2,"金塊":2},
      trainLimit:5
    };
  }

  function load(){
    const s = JSON.parse(localStorage.getItem("gm_v090")||"null");
    if(s) Object.assign(window, s);
    else Object.assign(window, defaultData());
    todayTrained = [];
  }
  function save(){
    const toSave = {warriors, freeAgents, otherTeams, money, salaryCap, lastDate, firstRoundPicks, trainLimit};
    localStorage.setItem("gm_v090", JSON.stringify(toSave));
  }

  function autoReset(){
    const d = new Date().toDateString();
    if(lastDate !== d){
      warriors.forEach(p=>p.trainedToday=false);
      lastDate = d;
      save();
    }
  }

  function renderDate(){
    const d = new Date().toLocaleDateString();
    const sal = warriors.reduce((a,p)=>a+p.salary,0);
    document.getElementById("dateDisplay").textContent = "｜今天：" + d;
    document.getElementById("moneyDisplay").textContent = 
      `｜資金：$${money}M｜工資：${sal}M / ${salaryCap}M${sal>salaryCap?" ⚠️":""}｜首輪籤：${firstRoundPicks["勇士"]} 張`;
  }

  function getNext(r){ return order[order.indexOf(r)+1]||null; }
  function tryUpgrade(r){ return Math.random()<0.3; }

  function showWarriors(){
    document.getElementById("teamContainer").innerHTML = "";
    const d = document.createElement("div");
    d.innerHTML = "<h2>🏀 勇士陣容</h2>";
    let cnt=0;
    warriors.forEach((p,i)=>{
      const div = document.createElement("div");
      div.className = "player";
      const prog = p.trainProgress + "%";
      div.innerHTML = `
        <div class="player-info">
          <strong>${p.name}</strong>｜${p.rating} ${ratingStars(p.rating)}｜$${p.salary}M<br/>
          📈 進度：${prog} ${getNext(p.rating)?`(目標：${getNext(p.rating)})`: ''}
        </div>
        <button ${p.trainedToday|| cnt>=trainLimit? "disabled": ""}>訓練</button>`;
      const btn = div.querySelector("button");
      btn.onclick = ()=>{
        if(p.trainedToday || cnt>=trainLimit) return;
        p.trainedToday = true;
        cnt+=1;
        p.trainProgress = Math.min(100, p.trainProgress + Math.floor(Math.random()*20+10));
        let msg = `${p.name} 訓練 ${p.trainProgress}%！`;
        if(p.trainProgress>=100){
          if(tryUpgrade(p.rating) && getNext(p.rating)){
            p.rating = getNext(p.rating);
            msg += ` 升級成功！變成 ${p.rating}`;
          } else msg += " 但未升級，請繼續努力";
          p.trainProgress=0;
        }
        alert(msg);
        save(); renderDate(); showWarriors();
      };
      d.appendChild(div);
    });
    document.getElementById("teamContainer").appendChild(d);
  }

  function showFree(){
    const cont = document.getElementById("freeAgentContainer");
    cont.innerHTML = "<h2>📝 自由市場</h2>";
    freeAgents.forEach((p,i)=>{
      const div = document.createElement("div");
      div.className="player";
      div.innerHTML = `
        <div class="player-info">
          <strong>${p.name}</strong>｜${p.rating} ${ratingStars(p.rating)}｜$${p.salary}M
        </div>
        <button>簽約</button>`;
      const btn = div.querySelector("button");
      btn.onclick = ()=>{
        if(money < p.salary) return alert("資金不足");
        if(Math.random()*100 < p.signChance){
          warriors.push({ ...p, trainProgress:0, trainedToday:false });
          money -= p.salary;
          freeAgents.splice(i,1);
          alert(`${p.name} 加入成功`);
        } else alert(`${p.name} 拒絕簽約`);
        save(); renderDate(); showFree(); showWarriors();
      };
      cont.appendChild(div);
    });
  }

  function showTradeCenter(){
    const cont = document.getElementById("tradeContainer");
    cont.innerHTML = "<h2>🔁 交易中心</h2>";
    Object.keys(otherTeams).forEach(team=>{
      const btn = document.createElement("button");
      btn.textContent = team;
      btn.onclick = ()=> tradeUI(team);
      cont.appendChild(btn);
    });
  }

  function tradeUI(team){
    currentTradeTarget = team;
    const opp = otherTeams[team];
    const cont = document.getElementById("tradeContainer");
    cont.innerHTML = `<h2>🔁 與 ${team} 交易</h2>
      <p>最多三換三，可選首輪籤</p>`;
    const form = document.createElement("div");
    form.innerHTML = "<strong>選擇我方球員：</strong><br/>" +
      warriors.map((p,i)=> `<label><input data-type="my" type="checkbox" value="${i}"> ${p.name} (${p.rating})</label>`).join("") +
      `<br/><label><input type="checkbox" id="myPick"> 加入我方首輪籤</label><br/><hr>` +
      "<strong>對方球員：</strong><br/>" +
      opp.map((p,i)=> `<label><input data-type="their" type="checkbox" value="${i}"> ${p.name} (${p.rating})</label>`).join("") +
      `<br/><label><input type="checkbox" id="theirPick"> 要求對方首輪籤</label><br/><br/>` +
      `<button id="submitTrade">提出交易</button>` +
      `<div id="tradeMsg"></div>`;
    cont.appendChild(form);

    form.querySelector("#submitTrade").onclick = ()=>{
      const mySel = [...form.querySelectorAll('input[data-type="my"]:checked')].map(cb=>+cb.value);
      const theirSel = [...form.querySelectorAll('input[data-type="their"]:checked')].map(cb=>+cb.value);
      if(mySel.length>3||theirSel.length>3) return alert("最多 3 換 3");
      let myVal=mySel.reduce((s,i)=>s+ratingMap[warriors[i].rating],0);
      let theirVal=theirSel.reduce((s,i)=>s+ratingMap[opp[i].rating],0);
      if(form.querySelector("#myPick").checked){
        if(firstRoundPicks["勇士"]<=0) return alert("沒有籤可交易");
        myVal+=4;
      }
      if(form.querySelector("#theirPick").checked) theirVal+=4;
      const diff=myVal-theirVal;
      let msg="";
      if(diff>=2) msg="❌ 對方覺得你的方案不夠";
      else if(diff<=-4) msg="❌ 對方覺得賠太多";
      else {
        msg="✅ 交易成功";
        if(form.querySelector("#myPick").checked) firstRoundPicks["勇士"]--;
        if(form.querySelector("#theirPick").checked) firstRoundPicks["勇士"]++;
        const myTrade= mySel.map(i=>warriors[i]);
        const theirTrade= theirSel.map(i=>opp[i]);
        warriors = warriors.filter((_,i)=>!mySel.includes(i)).concat(theirTrade.map(p=>({...p, trainProgress:0, trainedToday:false}));
        otherTeams[team] = opp.filter((_,i)=>!theirSel.includes(i)).concat(myTrade);
        save(); renderDate(); showWarriors(); showTradeCenter();
      }
      form.querySelector("#tradeMsg").textContent = msg;
    };
  }

  function simulate(){
    const d = new Date().toDateString();
    if(lastDate===d) return alert("今天已模擬過");
    const teamNames=Object.keys(otherTeams);
    const targ=teamNames[Math.floor(Math.random()*teamNames.length)];
    const opp=otherTeams[targ];
    let ts = warriors.reduce((s,p)=>s + ratingMap[p.rating]*(Math.random()+0.5),0);
    let os = opp.reduce((s,p)=>s + ratingMap[p.rating]*(Math.random()+0.5),0);
    let mvp = warriors.reduce((best,p)=>{
      let sc = ratingMap[p.rating]*(Math.random()+0.5);
      return sc>best.score?{name:p.name,score:sc}:best;
    },{name:"",score:0});
    document.getElementById("gameResult").innerHTML = `<h2>📊 比賽結果</h2><p>勇士 ${Math.round(ts)} : ${Math.round(os)} ${targ}</p><p>🎖 MVP：${mvp.name}</p>`;
    lastDate=d; save(); renderDate();
  }

  document.addEventListener("DOMContentLoaded",()=>{
    load(); autoReset(); renderDate();
    showWarriors(); showFree(); showTradeCenter();
    document.getElementById("showWarriorsBtn").onclick=showWarriors;
    document.getElementById("showFreeAgentsBtn").onclick=showFree;
    document.getElementById("showTradeBtn").onclick=showTradeCenter;
    document.getElementById("simulateGameBtn").onclick=simulate;
    document.getElementById("resetTrainingBtn").onclick=()=>{todayTrained=[]; warriors.forEach(p=>p.trainedToday=false); save(); showWarriors();};
    document.getElementById("clearBtn").onclick=()=>{if(confirm("清除？")){localStorage.clear();location.reload();}};
  });
})();
</script>
</body></html>