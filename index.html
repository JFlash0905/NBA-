<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>🏀 Sniper J GM 模擬器 v0.9.0 Ultimate+</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    h1 { color: #2c3e50; }
    button {
      margin: 5px; padding: 10px; font-size: 16px;
      border-radius: 5px; cursor: pointer;
      background-color: #3498db; color: white; border: none;
    }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    .player {
      background: white; margin: 10px 0; padding: 10px;
      border-radius: 6px; display: flex; align-items: center; justify-content: space-between;
    }
    .player-info { flex-grow: 1; }
    .progress-bar {
      width: 100%; background: #ddd; border-radius: 4px;
      overflow: hidden; margin-top: 4px; height: 8px;
    }
    .progress-bar-inner {
      height: 100%; background: #4caf50; width: 0%;
    }
    .section { margin-top: 30px; }
    .container { max-width: 900px; margin: auto; }
    select, input[type="text"] {
      padding: 5px 8px; font-size: 14px; margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏀 Sniper J GM 模擬器 v0.9.0 Ultimate+</h1>
    <div>
      <button id="clearBtn">清空存檔</button>
      <span id="dateDisplay"></span>
      <div id="moneyDisplay"></div>
    </div>
    <div class="section">
      <button id="showWarriorsBtn">勇士陣容</button>
      <button id="showFreeAgentsBtn">自由市場</button>
      <button id="showTradeBtn">發起交易 (3換3)</button>
      <button id="simulateGameBtn">模擬比賽</button>
      <button id="resetTrainingBtn">重置訓練</button>
    </div>
    <div id="team"></div>
    <div id="freeAgents"></div>
    <div id="otherTeam"></div>
    <div id="gameResult"></div>
  </div>
  <script>
(() => {
  const ratingMap = { "C":1,"C+":2,"B-":3,"B":4,"B+":5,"A-":6,"A":7,"A+":8,"S":9,"S+":10 };
  const ratingStars = r => "★".repeat(Math.min(5, Math.round((ratingMap[r]||1)/2)));
  let warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit, todayTrained;
  let currentTradeTarget = null;

  function defaultData() {
    return {
      warriors: [
        { name:"Stephen Curry", rating:"S", salary:35, trainedToday:false, trainProgress:0 },
        { name:"Klay Thompson", rating:"B+", salary:20, trainedToday:false, trainProgress:0 },
        { name:"Draymond Green", rating:"B", salary:18, trainedToday:false, trainProgress:0 },
        { name:"Jonathan Kuminga", rating:"B", salary:15, trainedToday:false, trainProgress:0 },
        { name:"Andrew Wiggins", rating:"B+", salary:22, trainedToday:false, trainProgress:0 },
        { name:"Moses Moody", rating:"C+", salary:10, trainedToday:false, trainProgress:0 },
        { name:"Gary Payton II", rating:"C+", salary:9, trainedToday:false, trainProgress:0 },
        { name:"Brandin Podziemski", rating:"B-", salary:11, trainedToday:false, trainProgress:0 },
        { name:"Kevon Looney", rating:"C", salary:8, trainedToday:false, trainProgress:0 }
      ],
      freeAgents: [
        { name:"Malik Beasley", rating:"B", salary:15, signChance:60 },
        { name:"Robert Covington", rating:"B-", salary:12, signChance:50 },
        { name:"Dennis Smith Jr.", rating:"B-", salary:9, signChance:55 },
        { name:"Justise Winslow", rating:"C+", salary:7, signChance:45 },
        { name:"Tristan Thompson", rating:"C", salary:6, signChance:50 }
      ],
      otherTeams: {
        "雷霆":[
          { name:"Shai Gilgeous-Alexander", rating:"S", salary:34 },
          { name:"Jalen Williams", rating:"A", salary:20 },
          { name:"Chet Holmgren", rating:"A-", salary:18 },
          { name:"Josh Giddey", rating:"B+", salary:16 },
          { name:"Lu Dort", rating:"B", salary:14 },
          { name:"Isaiah Joe", rating:"B-", salary:10 }
        ],
        "金塊":[
          { name:"Nikola Jokic", rating:"S+", salary:38 },
          { name:"Jamal Murray", rating:"A", salary:27 },
          { name:"Aaron Gordon", rating:"B+", salary:24 },
          { name:"Michael Porter Jr.", rating:"B+", salary:22 },
          { name:"Kentavious Caldwell-Pope", rating:"B", salary:15 },
          { name:"Reggie Jackson", rating:"B-", salary:10 }
        ]
      },
      money:100, salaryCap:120, lastSimDate:null,
      firstRoundPicks:{"勇士":2,"雷霆":2,"金塊":2}, trainLimit:5
    };
  }

  function loadData(){
    try {
      const s = JSON.parse(localStorage.getItem("sj_gm_data_v090")||"null");
      if(s && s.warriors) Object.assign(window, s);
      else throw "";
    } catch {
      Object.assign(window, defaultData());
    }
    todayTrained = [];
  }

  function saveData(){
    localStorage.setItem("sj_gm_data_v090", JSON.stringify({
      warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit
    }));
  }

  function renderDate(){
    const now=new Date().toLocaleDateString();
    const sal=warriors.reduce((a,p)=>a+p.salary,0);
    document.getElementById("dateDisplay").textContent = "｜今天："+now;
    document.getElementById("moneyDisplay").textContent =
      `｜資金：$${money}M｜工資：${sal}M/${salaryCap}M${sal>salaryCap?" ⚠️":""}｜首輪籤：${firstRoundPicks["勇士"]}`;
  }

  function showWarriors(){
    const container=document.getElementById("team");
    let trainedCount = warriors.filter(p=>p.trainedToday).length;
    container.innerHTML = "<h2>🏀 勇士陣容</h2>";
    warriors.forEach((p,i)=>{
      container.innerHTML += `
        <div class="player">
          <div class="player-info">
            <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}｜$${p.salary}M<br/>
            📈 進度：${p.trainProgress}% ${getNextRating(p.rating)?`(升級目標：${getNextRating(p.rating)})`:''}
          </div>
          <button ${p.trainedToday||trainedCount>=trainLimit?"disabled":''}>訓練</button>
        </div>`;
    });
    container.querySelectorAll("button").forEach((btn,i)=>{
      btn.addEventListener("click",()=>{
        let p=warriors[i];
        if(p.trainedToday || trainedCount>=trainLimit) return;
        p.trainedToday=true;
        p.trainProgress = Math.min(100, p.trainProgress + Math.floor(Math.random()*20+10));
        let msg=`${p.name} 完成訓練，目前 ${p.trainProgress}%`;
        if(p.trainProgress>=100){
          if(tryUpgrade(p)) msg+=` 🎉 成功升級為 ${p.rating}!`;
          else msg+=` 可惜沒升級，繼續努力!`;
          p.trainProgress=0;
        }
        alert(msg);
        saveData(); showWarriors(); renderDate();
      });
    });
  }

  function showFreeAgents(){
    const c=document.getElementById("freeAgents");
    c.innerHTML="<h2>📝 自由市場</h2>";
    freeAgents.forEach((p,i)=>{
      c.innerHTML+=`
        <div class="player">
          <div class="player-info"><strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}｜$${p.salary}M</div>
          <button>簽約</button>
        </div>`;
    });
    c.querySelectorAll("button").forEach((btn,i)=>{
      btn.addEventListener("click",()=>{
        const p=freeAgents[i];
        if(money<p.salary) return alert("資金不足！");
        if(Math.random()*100 < p.signChance){
          warriors.push({ ...p, trainedToday:false, trainProgress:0 });
          money -= p.salary; freeAgents.splice(i,1);
          alert(`${p.name} 加入球隊！`);
        } else alert(`${p.name} 拒絕加入。`);
        saveData(); showFreeAgents(); showWarriors(); renderDate();
      });
    });
  }

  function showTradeUI(){
    const area=document.getElementById("otherTeam");
    area.innerHTML="<h2>🔁 交易中心</h2>";
    Object.keys(otherTeams).forEach(tm=>{
      area.innerHTML+=`<button data-team="${tm}">${tm}</button>`;
    });
    area.querySelectorAll("button[data-team]").forEach(btn=>{
      btn.addEventListener("click",()=>prepareTradeUI(btn.dataset.team));
    });
  }

  function prepareTradeUI(team){
    currentTradeTarget=team;
    const opp=otherTeams[team];
    const area=document.getElementById("otherTeam");
    area.innerHTML=`
      <h2>💼 與 ${team} 交易</h2>
      <p>最多 3 換 3，可加/取首輪籤</p>
      <div id="tradeArea"></div><div id="tradeResult"></div>`;
    const ta=document.getElementById("tradeArea");
    ta.innerHTML = `<h3>我方球員</h3>` + warriors.map((p,i)=>`
      <label><input type="checkbox" class="w-trade" value="${i}"> ${p.name}｜${p.rating}</label><br/>`
    ).join("") + `<label><input type="checkbox" id="myPick"> 加入我方首輪籤</label><hr/>` +
    `<h3>${team}球員</h3>` + opp.map((p,i)=>`
      <label><input type="checkbox" class="o-trade" value="${i}"> ${p.name}｜${p.rating}</label><br/>`
    ).join("") + `<label><input type="checkbox" id="theirPick"> 要求對方首輪籤</label><br/><button id="submitTrade">提出交易</button>`;
    document.getElementById("submitTrade").addEventListener("click",()=>{
      const mySel=[...ta.querySelectorAll(".w-trade:checked")].map(cb=>warriors[cb.value]);
      const theirSel=[...ta.querySelectorAll(".o-trade:checked")].map(cb=>opp[cb.value]);
      if(mySel.length>3||theirSel.length>3) return alert("最多 3 換 3！");
      let myVal=mySel.reduce((s,p)=>s+ratingMap[p.rating],0);
      let theirVal=theirSel.reduce((s,p)=>s+ratingMap[p.rating],0);
      if(document.getElementById("myPick").checked){
        if(firstRoundPicks["勇士"]<=0) return alert("沒籤了");
        myVal+=4;
      }
      if(document.getElementById("theirPick").checked) theirVal+=4;
      let diff=myVal-theirVal, msg="";
      if(diff>2) msg="❌ 你給太多";
      else if(diff<-4) msg="❌ 對方覺得吃虧太多";
      else {
        msg="✅ 交易成功！";
        if(document.getElementById("myPick").checked) firstRoundPicks["勇士"]--;
        if(document.getElementById("theirPick").checked) firstRoundPicks["勇士"]++;
        warriors = warriors.filter(p=>!mySel.includes(p)).concat(theirSel.map(p=>({...p,trainProgress:0, trainedToday:false})));
        otherTeams[team] = opp.filter(p=>!theirSel.includes(p)).concat(mySel);
        saveData(); showWarriors(); renderDate();
      }
      document.getElementById("tradeResult").textContent = msg;
    });
  }

  function simulateGame(){
    const today=new Date().toDateString();
    if(lastSimDate===today) return alert("今天已比賽！");
    const teams=Object.keys(otherTeams);
    const rt=teams[Math.floor(Math.random()*teams.length)], opp=otherTeams[rt];
    const teamScore=warriors.reduce((s,p)=>s+ratingMap[p.rating]*(Math.random()+0.5),0);
    const oppScore=opp.reduce((s,p)=>s+ratingMap[p.rating]*(Math.random()+0.5),0);
    const mvp=warriors.reduce((top,p)=>{
      const sc=ratingMap[p.rating]*(Math.random()+0.5);
      return sc>top.score?{name:p.name,score:sc}:top;
    },{name:"",score:0});
    document.getElementById("gameResult").innerHTML=`
      <h2>📊 模擬比賽結果</h2>
      <p>🏀 勇士 ${Math.round(teamScore)} : ${Math.round(oppScore)} ${rt}</p>
      <p>🎖 MVP：${mvp.name}</p>`;
    lastSimDate=today; saveData(); renderDate();
  }

  function getNextRating(r){
    const ord=["C","C+","B-","B","B+","A-","A","A+","S","S+"];
    const idx=ord.indexOf(r);
    return idx>=0&&idx<ord.length-1?ord[idx+1]:null;
  }
  function tryUpgrade(p){
    const nr=getNextRating(p.rating);
    if(!nr) return false;
    if(Math.random()<0.3){p.rating=nr; return true;}
    return false;
  }

  function resetTraining(){ warriors.forEach(p=>p.trainedToday=false); alert("已重置訓練！"); saveData(); showWarriors(); }

  function dailyAutoUpdate(){
    const t=new Date().toDateString(), sd=localStorage.getItem("sj_last_date");
    if(sd!==t){
      warriors.forEach(p=>p.trainedToday=false);
      localStorage.setItem("sj_last_date",t);
      saveData(); renderDate(); showWarriors();
    }
  }

  document.addEventListener("DOMContentLoaded",()=>{
    loadData(); dailyAutoUpdate(); renderDate(); showWarriors();
    document.getElementById("showWarriorsBtn").onclick=showWarriors;
    document.getElementById("showFreeAgentsBtn").onclick=showFreeAgents;
    document.getElementById("showTradeBtn").onclick=showTradeUI;
    document.getElementById("simulateGameBtn").onclick=simulateGame;
    document.getElementById("resetTrainingBtn").onclick=resetTraining;
    document.getElementById("clearBtn").onclick=()=>{
      if(confirm("確認清除資料？")){ localStorage.clear(); location.reload();}
    };
    setInterval(dailyAutoUpdate,60000);
  });
})();
  </script>
</body>
</html>