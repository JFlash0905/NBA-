<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>🏀 Sniper J GM 模擬器 v0.9.0 Ultimate+</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    h1 { color: #2c3e50; }
    button {
      margin: 5px; padding: 10px; font-size: 16px;
      border-radius: 5px; cursor: pointer;
      background-color: #3498db; color: white; border: none;
    }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    .player {
      background: white; margin: 10px 0; padding: 10px;
      border-radius: 6px; display: flex;
      align-items: center; justify-content: space-between;
    }
    .player-info { flex-grow: 1; }
    .progress-bar {
      width: 100%; background: #ddd; border-radius: 4px;
      overflow: hidden; margin-top: 4px; height: 8px;
    }
    .progress-bar-inner {
      height: 100%; background: #4caf50; width: 0%;
    }
    .section { margin-top: 30px; }
    .container { max-width: 900px; margin: auto; }
    select, input[type="text"] {
      padding: 5px 8px; font-size: 14px; margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏀 Sniper J GM 模擬器 v0.9.0 Ultimate+</h1>
    <div>
      <button id="clearBtn">清空存檔</button>
      <span id="dateDisplay"></span>
      <div id="moneyDisplay"></div>
    </div>

    <div class="section">
      <button id="showWarriorsBtn">勇士陣容</button>
      <button id="showFreeAgentsBtn">自由市場</button>
      <button id="showTradeBtn">發起交易 (3換3)</button>
      <button id="simulateGameBtn">模擬比賽</button>
      <button id="resetTrainingBtn">重置訓練</button>
    </div>

    <!-- 主要顯示區域 -->
    <div id="teamContainer"></div>
    <div id="freeAgentContainer"></div>
    <div id="tradeContainer"></div>
    <div id="gameResult"></div>
  </div>
  <script>
(() => {
  const ratingMap = {
    "C": 1, "C+": 2, "B-": 3, "B": 4, "B+": 5,
    "A-": 6, "A": 7, "A+": 8, "S": 9, "S+": 10
  };
  const ratingStars = r => "★".repeat(Math.min(5, Math.round((ratingMap[r] || 1) / 2)));

  let warriors, freeAgents, otherTeams, money, salaryCap;
  let lastSimDate, firstRoundPicks, trainLimit, todayTrained = [];

  function defaultData() {
    return {
      warriors: [
        { name:"Stephen Curry", rating:"S", salary:35, train:0 },
        { name:"Klay Thompson", rating:"B+", salary:20, train:0 },
        { name:"Draymond Green", rating:"B", salary:18, train:0 },
        { name:"Jonathan Kuminga", rating:"B", salary:15, train:0 },
        { name:"Andrew Wiggins", rating:"B+", salary:22, train:0 },
        { name:"Moses Moody", rating:"C+", salary:10, train:0 },
        { name:"Gary Payton II", rating:"C+", salary:9, train:0 },
        { name:"Brandin Podziemski", rating:"B-", salary:11, train:0 },
        { name:"Kevon Looney", rating:"C", salary:8, train:0 }
      ],
      freeAgents: [
        { name:"Malik Beasley", rating:"B", salary:15, signChance:60 },
        { name:"Robert Covington", rating:"B-", salary:12, signChance:50 },
        { name:"Dennis Smith Jr.", rating:"B-", salary:9, signChance:55 },
        { name:"Justise Winslow", rating:"C+", salary:7, signChance:45 },
        { name:"Tristan Thompson", rating:"C", salary:6, signChance:50 }
      ],
      otherTeams: {
        "雷霆": [
          { name:"Shai Gilgeous-Alexander", rating:"S", salary:34 },
          { name:"Jalen Williams", rating:"A", salary:20 },
          { name:"Chet Holmgren", rating:"A-", salary:18 },
          { name:"Josh Giddey", rating:"B+", salary:16 },
          { name:"Lu Dort", rating:"B", salary:14 },
          { name:"Isaiah Joe", rating:"B-", salary:10 }
        ],
        "金塊": [
          { name:"Nikola Jokic", rating:"S+", salary:38 },
          { name:"Jamal Murray", rating:"A", salary:27 },
          { name:"Aaron Gordon", rating:"B+", salary:24 },
          { name:"Michael Porter Jr.", rating:"B+", salary:22 },
          { name:"Kentavious Caldwell-Pope", rating:"B", salary:15 },
          { name:"Reggie Jackson", rating:"B-", salary:10 }
        ]
        // 其他球隊略，後續我會補齊
      },
      money: 100,
      salaryCap: 120,
      lastSimDate: null,
      firstRoundPicks: { "勇士": 2, "雷霆": 2, "金塊": 2 },
      trainLimit: 5
    };
  }

  function loadData() {
    try {
      const saved = JSON.parse(localStorage.getItem("sj_gm_data_v090") || "null");
      if (saved && saved.warriors && saved.freeAgents && saved.otherTeams) {
        ({ warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit } = saved);
      } else throw new Error("無資料");
    } catch {
      ({ warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit } = defaultData());
      saveData();
    }
    todayTrained = [];
  }

  function saveData() {
    localStorage.setItem("sj_gm_data_v090", JSON.stringify({
      warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit
    }));
  }
    function renderDate() {
    const now = new Date().toLocaleDateString();
    const teamSalary = warriors.reduce((sum, p) => sum + (p.salary || 0), 0);
    const warning = teamSalary > salaryCap ? " ⚠️" : "";
    document.getElementById("dateDisplay").textContent = "｜今天：" + now;
    document.getElementById("moneyDisplay").textContent =
      `｜資金：$${money}M｜工資：${teamSalary}M／${salaryCap}M${warning}｜首輪籤：${firstRoundPicks["勇士"]} 張`;
  }

  function showWarriors() {
    const container = document.getElementById("team");
    container.innerHTML = "<h2>🏀 勇士陣容</h2>" + warriors.map((p, i) => {
      const trained = todayTrained.includes(i);
      const progress = Math.min(100, Math.round((p.train || 0) * 10));
      return `
        <div class="player">
          <div class="player-info">
            <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}｜$${p.salary}M
            <br/>📈 訓練進度：${progress}%
          </div>
          <button ${trained ? "disabled" : ""}>訓練</button>
        </div>
      `;
    }).join("");

    container.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        if (todayTrained.includes(i)) return;
        if (todayTrained.length >= trainLimit) {
          alert("今日訓練人數已達上限！");
          return;
        }
        warriors[i].train = (warriors[i].train || 0) + 1;
        todayTrained.push(i);

        // 升級機率系統
        const ratingKeys = Object.keys(ratingMap);
        const curIndex = ratingKeys.indexOf(warriors[i].rating);
        const chance = Math.random();
        if (chance < 0.1 && curIndex < ratingKeys.length - 1) {
          warriors[i].rating = ratingKeys[curIndex + 1];
          alert(`${warriors[i].name} 升級為 ${warriors[i].rating}！`);
        } else {
          alert(`${warriors[i].name} 完成訓練！`);
        }

        saveData();
        showWarriors();
        renderDate();
      });
    });
  }

  function resetTraining() {
    todayTrained = [];
    alert("已重置每日訓練狀態！");
    showWarriors();
  }
    function showFreeAgents() {
    const container = document.getElementById("freeAgents");
    container.innerHTML = "<h2>📝 自由市場</h2>" + freeAgents.map((p, i) => `
      <div class="player">
        <div class="player-info">
          <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}｜$${p.salary}M
        </div>
        <button>簽約</button>
      </div>
    `).join("");

    container.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        const p = freeAgents[i];
        if (money < p.salary) return alert("💸 資金不足！");
        if (Math.random() * 100 < p.signChance) {
          warriors.push({ ...p, train: 0 });
          money -= p.salary;
          alert(`${p.name} 簽約成功！`);
          freeAgents.splice(i, 1);
        } else {
          alert(`${p.name} 拒絕加入`);
        }
        saveData();
        showFreeAgents();
        showWarriors();
        renderDate();
      });
    });
  }

  function showOtherTeams() {
    const area = document.getElementById("teamSelectArea");
    area.innerHTML = "<h2>🌍 交易對象選擇</h2>" + Object.keys(otherTeams).map(name => `
      <button>${name}</button>
    `).join("");

    area.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        currentTradeTarget = btn.textContent;
        prepareTradeUI();
      });
    });
  }

  function simulateGame() {
    const today = new Date().toDateString();
    if (lastSimDate === today) return alert("今天已模擬過比賽！");
    const teamNames = Object.keys(otherTeams);
    const randomTeam = teamNames[Math.floor(Math.random() * teamNames.length)];
    const opp = otherTeams[randomTeam];

    const teamScore = warriors.reduce((sum, p) => sum + ratingMap[p.rating] * (Math.random() + 0.5), 0);
    const oppScore = opp.reduce((sum, p) => sum + ratingMap[p.rating] * (Math.random() + 0.5), 0);
    const mvp = warriors.reduce((top, p) => {
      const score = ratingMap[p.rating] * (Math.random() + 0.5);
      return score > top.score ? { name: p.name, score } : top;
    }, { name: "", score: 0 });

    document.getElementById("gameResult").innerHTML = `
      <h2>📊 模擬比賽結果</h2>
      <p>🏀 勇士 ${Math.round(teamScore)} : ${Math.round(oppScore)} ${randomTeam}</p>
      <p>🎖 MVP：${mvp.name}</p>
    `;
    lastSimDate = today;
    saveData();
    renderDate();
  }
    function prepareTradeUI() {
    const opp = otherTeams[currentTradeTarget];
    const container = document.getElementById("otherTeam");
    container.innerHTML = `
      <h2>💼 與 ${currentTradeTarget} 交易</h2>
      <p>請選擇雙方最多3位球員與是否加入首輪籤。</p>
      <div id="tradeArea">
        <div><strong>我方球員：</strong></div>
        ${warriors.map((p, i) => `
          <label><input type="checkbox" class="w-trade" value="${i}"> ${p.name}｜${p.rating}</label><br/>
        `).join("")}
        <label><input type="checkbox" id="myPick"> 加入我方首輪籤</label>
        <hr/>
        <div><strong>${currentTradeTarget} 球員：</strong></div>
        ${opp.map((p, i) => `
          <label><input type="checkbox" class="o-trade" value="${i}"> ${p.name}｜${p.rating}</label><br/>
        `).join("")}
        <label><input type="checkbox" id="theirPick"> 要求對方首輪籤</label>
        <br/><br/>
        <button id="submitTrade">提出交易</button>
        <div id="tradeResult"></div>
      </div>
    `;

    document.getElementById("submitTrade").addEventListener("click", () => {
      const mySelected = [...document.querySelectorAll(".w-trade:checked")].map(cb => warriors[cb.value]);
      const theirSelected = [...document.querySelectorAll(".o-trade:checked")].map(cb => opp[cb.value]);

      if (mySelected.length === 0 && theirSelected.length === 0) return alert("請至少選擇一位球員！");
      if (mySelected.length > 3 || theirSelected.length > 3) return alert("最多3換3！");

      let myValue = mySelected.reduce((sum, p) => sum + ratingMap[p.rating], 0);
      let theirValue = theirSelected.reduce((sum, p) => sum + ratingMap[p.rating], 0);

      if (document.getElementById("myPick").checked) {
        if (firstRoundPicks <= 0) return alert("沒有首輪籤可交易！");
        myValue += 4; // 自定首輪價值
      }
      if (document.getElementById("theirPick").checked) theirValue += 4;

      const diff = myValue - theirValue;
      let msg = "";

      if (diff >= 2) msg = "❌ 對方認為你提出的太少了";
      else if (diff <= -4) msg = "❌ 對方覺得他們吃虧太多";
      else {
        msg = "✅ 交易成功！";
        // 執行交易
        if (document.getElementById("myPick").checked) firstRoundPicks--;
        if (document.getElementById("theirPick").checked) firstRoundPicks++;

        // 移動球員
        warriors = warriors.filter(p => !mySelected.includes(p)).concat(theirSelected.map(p => ({ ...p, train: 0 })));
        otherTeams[currentTradeTarget] = opp.filter(p => !theirSelected.includes(p)).concat(mySelected.map(p => ({ ...p })));

        saveData();
        showWarriors();
        renderDate();
      }

      document.getElementById("tradeResult").textContent = msg;
    });
  }
    function showWarriors() {
    const container = document.getElementById("team");
    container.innerHTML = "<h2>🏀 勇士陣容</h2>";
    const trainedTodayCount = warriors.filter(p => p.trainedToday).length;

    warriors.forEach((p, i) => {
      if (!p.trainProgress) p.trainProgress = 0;
      const nextRating = getNextRating(p.rating);
      container.innerHTML += `
        <div class="player">
          <div class="player-info">
            <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}｜$${p.salary}M<br/>
            ${p.trainedToday ? "🧠 已訓練｜" : ""}
            📈 訓練進度：${p.trainProgress}% ${nextRating ? `(目標：${nextRating})` : ""}
          </div>
          <button ${p.trainedToday || trainedTodayCount >= 5 ? "disabled" : ""}>訓練</button>
        </div>
      `;
    });

    container.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        const p = warriors[i];
        if (p.trainedToday || trainedTodayCount >= 5) return;
        p.trainedToday = true;
        p.trainProgress = Math.min(100, p.trainProgress + Math.floor(Math.random() * 20 + 10));

        let msg = `${p.name} 完成訓練！（目前 ${p.trainProgress}%）`;
        if (p.trainProgress >= 100) {
          const upgraded = tryUpgrade(p);
          msg += upgraded ? `🎉 成功升級為 ${p.rating}！` : `😅 沒有升級，繼續努力！`;
          p.trainProgress = 0;
        }

        alert(msg);
        saveData();
        showWarriors();
      });
    });
  }

  function getNextRating(rating) {
    const order = ["C", "C+", "B-", "B", "B+", "A-", "A", "A+", "S", "S+"];
    const idx = order.indexOf(rating);
    return idx >= 0 && idx < order.length - 1 ? order[idx + 1] : null;
  }

  function tryUpgrade(player) {
    const next = getNextRating(player.rating);
    if (!next) return false;
    const chance = Math.random();
    if (chance < 0.3) {
      player.rating = next;
      return true;
    }
    return false;
  }

  function resetTraining() {
    warriors.forEach(p => p.trainedToday = false);
    alert("所有球員訓練狀態已重置（每日自動進行）！");
    saveData();
    showWarriors();
  }

  // 自動每日重置
  setInterval(() => {
    const now = new Date().toDateString();
    if (lastSimDate !== now) {
      warriors.forEach(p => p.trainedToday = false);
      lastSimDate = now;
      saveData();
      renderDate();
      showWarriors();
    }
  }, 10000); // 每 10 秒檢查一次（可改成更久）
   function showTradeUI() {
    const teamNames = Object.keys(otherTeams);
    const tradeArea = document.getElementById("otherTeam");
    tradeArea.innerHTML = "<h2>🔄 交易中心</h2>";

    let selectedTeam = null;
    let selectedMy = [], selectedTheir = [];

    // 選擇隊伍
    tradeArea.innerHTML += "<p>選擇交易對象：</p>" + teamNames.map(name => `<button>${name}</button>`).join("");

    tradeArea.querySelectorAll("button").forEach((btn, idx) => {
      btn.addEventListener("click", () => {
        selectedTeam = teamNames[idx];
        renderTradeSelection(selectedTeam);
      });
    });

    function renderTradeSelection(teamName) {
      const theirPlayers = otherTeams[teamName];
      tradeArea.innerHTML = `<h2>🔁 與 ${teamName} 進行交易</h2>`;

      tradeArea.innerHTML += "<h3>💛 我方出讓球員</h3>" + warriors.map((p, i) => `
        <div class="player">
          <div class="player-info">${p.name}｜${p.rating}｜$${p.salary}M</div>
          <input type="checkbox" data-type="my" data-index="${i}">
        </div>
      `).join("");

      tradeArea.innerHTML += "<h3>💙 對方球員</h3>" + theirPlayers.map((p, i) => `
        <div class="player">
          <div class="player-info">${p.name}｜${p.rating}｜$${p.salary}M</div>
          <input type="checkbox" data-type="their" data-index="${i}">
        </div>
      `).join("");

      tradeArea.innerHTML += `<button id="confirmTradeBtn">✅ 確認交易</button>`;

      tradeArea.querySelectorAll("input").forEach(input => {
        input.addEventListener("change", () => {
          const type = input.dataset.type;
          const index = parseInt(input.dataset.index);
          if (type === "my") {
            selectedMy = Array.from(tradeArea.querySelectorAll('input[data-type="my"]:checked')).map(i => parseInt(i.dataset.index));
          } else {
            selectedTheir = Array.from(tradeArea.querySelectorAll('input[data-type="their"]:checked')).map(i => parseInt(i.dataset.index));
          }
        });
      });

      tradeArea.querySelector("#confirmTradeBtn").addEventListener("click", () => {
        if (selectedMy.length === 0 && selectedTheir.length === 0) return alert("請選擇至少一位球員。");
        if (selectedMy.length > 3 || selectedTheir.length > 3) return alert("最多只能 3 換 3。");

        const myTotal = selectedMy.reduce((sum, i) => sum + warriors[i].salary, 0);
        const theirTotal = selectedTheir.reduce((sum, i) => sum + theirPlayers[i].salary, 0);
        if (Math.abs(myTotal - theirTotal) > 20) {
          return alert("薪資差距過大，交易被拒絕！");
        }

        const myTraded = selectedMy.map(i => warriors[i]);
        const theirTraded = selectedTheir.map(i => theirPlayers[i]);

        // 執行交易
        warriors = warriors.filter((_, i) => !selectedMy.includes(i)).concat(theirTraded.map(p => ({ ...p, trainedToday: false })));
        otherTeams[teamName] = theirPlayers.filter((_, i) => !selectedTheir.includes(i)).concat(myTraded);

        alert("✅ 交易成功！");
        saveData();
        showWarriors();
        renderDate();
        showTradeUI();
      });
    }
  }

  // 每日自動重置功能
  function dailyAutoUpdate() {
    const today = new Date().toDateString();
    const storedDate = localStorage.getItem("sj_last_date");
    if (storedDate !== today) {
      warriors.forEach(p => p.trainedToday = false);
      localStorage.setItem("sj_last_date", today);
      console.log("📆 訓練已自動重置！");
    }
  }

  // 初始化與綁定
  document.addEventListener("DOMContentLoaded", () => {
    loadData();
    dailyAutoUpdate();
    renderDate();
    showWarriors();

    document.getElementById("showWarriorsBtn").addEventListener("click", showWarriors);
    document.getElementById("showFreeAgentsBtn").addEventListener("click", showFreeAgents);
    document.getElementById("selectTeamBtn").addEventListener("click", showOtherTeams);
    document.getElementById("simulateGameBtn").addEventListener("click", simulateGame);
    document.getElementById("resetTrainingBtn").addEventListener("click", resetTraining);
    document.getElementById("clearBtn").addEventListener("click", () => {
      if (confirm("❌ 確定清空所有進度？")) {
        localStorage.removeItem("sj_gm_data");
        localStorage.removeItem("sj_last_date");
        location.reload();
      }
    });

    // 額外：綁定交易中心入口（你可以加按鈕觸發）
    const tradeBtn = document.createElement("button");
    tradeBtn.textContent = "交易中心";
    tradeBtn.onclick = showTradeUI;
    document.querySelector(".section").appendChild(tradeBtn);
  });
})();
    </script>
  </div>
</body>
</html>
