<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ€ Sniper J GM æ¨¡æ“¬å™¨ v0.9.0 Ultimate+</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    h1 { color: #2c3e50; }
    button {
      margin: 5px; padding: 10px; font-size: 16px;
      border-radius: 5px; cursor: pointer;
      background-color: #3498db; color: white; border: none;
    }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    .player {
      background: white; margin: 10px 0; padding: 10px;
      border-radius: 6px; display: flex;
      align-items: center; justify-content: space-between;
    }
    .player-info { flex-grow: 1; }
    .progress-bar {
      width: 100%; background: #ddd; border-radius: 4px;
      overflow: hidden; margin-top: 4px; height: 8px;
    }
    .progress-bar-inner {
      height: 100%; background: #4caf50; width: 0%;
    }
    .section { margin-top: 30px; }
    .container { max-width: 900px; margin: auto; }
    select, input[type="text"] {
      padding: 5px 8px; font-size: 14px; margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ€ Sniper J GM æ¨¡æ“¬å™¨ v0.9.0 Ultimate+</h1>
    <div>
      <button id="clearBtn">æ¸…ç©ºå­˜æª”</button>
      <span id="dateDisplay"></span>
      <div id="moneyDisplay"></div>
    </div>

    <div class="section">
      <button id="showWarriorsBtn">å‹‡å£«é™£å®¹</button>
      <button id="showFreeAgentsBtn">è‡ªç”±å¸‚å ´</button>
      <button id="showTradeBtn">ç™¼èµ·äº¤æ˜“ (3æ›3)</button>
      <button id="simulateGameBtn">æ¨¡æ“¬æ¯”è³½</button>
      <button id="resetTrainingBtn">é‡ç½®è¨“ç·´</button>
    </div>

    <!-- ä¸»è¦é¡¯ç¤ºå€åŸŸ -->
    <div id="teamContainer"></div>
    <div id="freeAgentContainer"></div>
    <div id="tradeContainer"></div>
    <div id="gameResult"></div>
  </div>
  <script>
(() => {
  const ratingMap = {
    "C": 1, "C+": 2, "B-": 3, "B": 4, "B+": 5,
    "A-": 6, "A": 7, "A+": 8, "S": 9, "S+": 10
  };
  const ratingStars = r => "â˜…".repeat(Math.min(5, Math.round((ratingMap[r] || 1) / 2)));

  let warriors, freeAgents, otherTeams, money, salaryCap;
  let lastSimDate, firstRoundPicks, trainLimit, todayTrained = [];

  function defaultData() {
    return {
      warriors: [
        { name:"Stephen Curry", rating:"S", salary:35, train:0 },
        { name:"Klay Thompson", rating:"B+", salary:20, train:0 },
        { name:"Draymond Green", rating:"B", salary:18, train:0 },
        { name:"Jonathan Kuminga", rating:"B", salary:15, train:0 },
        { name:"Andrew Wiggins", rating:"B+", salary:22, train:0 },
        { name:"Moses Moody", rating:"C+", salary:10, train:0 },
        { name:"Gary Payton II", rating:"C+", salary:9, train:0 },
        { name:"Brandin Podziemski", rating:"B-", salary:11, train:0 },
        { name:"Kevon Looney", rating:"C", salary:8, train:0 }
      ],
      freeAgents: [
        { name:"Malik Beasley", rating:"B", salary:15, signChance:60 },
        { name:"Robert Covington", rating:"B-", salary:12, signChance:50 },
        { name:"Dennis Smith Jr.", rating:"B-", salary:9, signChance:55 },
        { name:"Justise Winslow", rating:"C+", salary:7, signChance:45 },
        { name:"Tristan Thompson", rating:"C", salary:6, signChance:50 }
      ],
      otherTeams: {
        "é›·éœ†": [
          { name:"Shai Gilgeous-Alexander", rating:"S", salary:34 },
          { name:"Jalen Williams", rating:"A", salary:20 },
          { name:"Chet Holmgren", rating:"A-", salary:18 },
          { name:"Josh Giddey", rating:"B+", salary:16 },
          { name:"Lu Dort", rating:"B", salary:14 },
          { name:"Isaiah Joe", rating:"B-", salary:10 }
        ],
        "é‡‘å¡Š": [
          { name:"Nikola Jokic", rating:"S+", salary:38 },
          { name:"Jamal Murray", rating:"A", salary:27 },
          { name:"Aaron Gordon", rating:"B+", salary:24 },
          { name:"Michael Porter Jr.", rating:"B+", salary:22 },
          { name:"Kentavious Caldwell-Pope", rating:"B", salary:15 },
          { name:"Reggie Jackson", rating:"B-", salary:10 }
        ]
        // å…¶ä»–çƒéšŠç•¥ï¼Œå¾ŒçºŒæˆ‘æœƒè£œé½Š
      },
      money: 100,
      salaryCap: 120,
      lastSimDate: null,
      firstRoundPicks: { "å‹‡å£«": 2, "é›·éœ†": 2, "é‡‘å¡Š": 2 },
      trainLimit: 5
    };
  }

  function loadData() {
    try {
      const saved = JSON.parse(localStorage.getItem("sj_gm_data_v090") || "null");
      if (saved && saved.warriors && saved.freeAgents && saved.otherTeams) {
        ({ warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit } = saved);
      } else throw new Error("ç„¡è³‡æ–™");
    } catch {
      ({ warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit } = defaultData());
      saveData();
    }
    todayTrained = [];
  }

  function saveData() {
    localStorage.setItem("sj_gm_data_v090", JSON.stringify({
      warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, firstRoundPicks, trainLimit
    }));
  }
    function renderDate() {
    const now = new Date().toLocaleDateString();
    const teamSalary = warriors.reduce((sum, p) => sum + (p.salary || 0), 0);
    const warning = teamSalary > salaryCap ? " âš ï¸" : "";
    document.getElementById("dateDisplay").textContent = "ï½œä»Šå¤©ï¼š" + now;
    document.getElementById("moneyDisplay").textContent =
      `ï½œè³‡é‡‘ï¼š$${money}Mï½œå·¥è³‡ï¼š${teamSalary}Mï¼${salaryCap}M${warning}ï½œé¦–è¼ªç±¤ï¼š${firstRoundPicks["å‹‡å£«"]} å¼µ`;
  }

  function showWarriors() {
    const container = document.getElementById("team");
    container.innerHTML = "<h2>ğŸ€ å‹‡å£«é™£å®¹</h2>" + warriors.map((p, i) => {
      const trained = todayTrained.includes(i);
      const progress = Math.min(100, Math.round((p.train || 0) * 10));
      return `
        <div class="player">
          <div class="player-info">
            <strong>${p.name}</strong>ï½œ${p.rating}ï½œ${ratingStars(p.rating)}ï½œ$${p.salary}M
            <br/>ğŸ“ˆ è¨“ç·´é€²åº¦ï¼š${progress}%
          </div>
          <button ${trained ? "disabled" : ""}>è¨“ç·´</button>
        </div>
      `;
    }).join("");

    container.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        if (todayTrained.includes(i)) return;
        if (todayTrained.length >= trainLimit) {
          alert("ä»Šæ—¥è¨“ç·´äººæ•¸å·²é”ä¸Šé™ï¼");
          return;
        }
        warriors[i].train = (warriors[i].train || 0) + 1;
        todayTrained.push(i);

        // å‡ç´šæ©Ÿç‡ç³»çµ±
        const ratingKeys = Object.keys(ratingMap);
        const curIndex = ratingKeys.indexOf(warriors[i].rating);
        const chance = Math.random();
        if (chance < 0.1 && curIndex < ratingKeys.length - 1) {
          warriors[i].rating = ratingKeys[curIndex + 1];
          alert(`${warriors[i].name} å‡ç´šç‚º ${warriors[i].rating}ï¼`);
        } else {
          alert(`${warriors[i].name} å®Œæˆè¨“ç·´ï¼`);
        }

        saveData();
        showWarriors();
        renderDate();
      });
    });
  }

  function resetTraining() {
    todayTrained = [];
    alert("å·²é‡ç½®æ¯æ—¥è¨“ç·´ç‹€æ…‹ï¼");
    showWarriors();
  }
    function showFreeAgents() {
    const container = document.getElementById("freeAgents");
    container.innerHTML = "<h2>ğŸ“ è‡ªç”±å¸‚å ´</h2>" + freeAgents.map((p, i) => `
      <div class="player">
        <div class="player-info">
          <strong>${p.name}</strong>ï½œ${p.rating}ï½œ${ratingStars(p.rating)}ï½œ$${p.salary}M
        </div>
        <button>ç°½ç´„</button>
      </div>
    `).join("");

    container.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        const p = freeAgents[i];
        if (money < p.salary) return alert("ğŸ’¸ è³‡é‡‘ä¸è¶³ï¼");
        if (Math.random() * 100 < p.signChance) {
          warriors.push({ ...p, train: 0 });
          money -= p.salary;
          alert(`${p.name} ç°½ç´„æˆåŠŸï¼`);
          freeAgents.splice(i, 1);
        } else {
          alert(`${p.name} æ‹’çµ•åŠ å…¥`);
        }
        saveData();
        showFreeAgents();
        showWarriors();
        renderDate();
      });
    });
  }

  function showOtherTeams() {
    const area = document.getElementById("teamSelectArea");
    area.innerHTML = "<h2>ğŸŒ äº¤æ˜“å°è±¡é¸æ“‡</h2>" + Object.keys(otherTeams).map(name => `
      <button>${name}</button>
    `).join("");

    area.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        currentTradeTarget = btn.textContent;
        prepareTradeUI();
      });
    });
  }

  function simulateGame() {
    const today = new Date().toDateString();
    if (lastSimDate === today) return alert("ä»Šå¤©å·²æ¨¡æ“¬éæ¯”è³½ï¼");
    const teamNames = Object.keys(otherTeams);
    const randomTeam = teamNames[Math.floor(Math.random() * teamNames.length)];
    const opp = otherTeams[randomTeam];

    const teamScore = warriors.reduce((sum, p) => sum + ratingMap[p.rating] * (Math.random() + 0.5), 0);
    const oppScore = opp.reduce((sum, p) => sum + ratingMap[p.rating] * (Math.random() + 0.5), 0);
    const mvp = warriors.reduce((top, p) => {
      const score = ratingMap[p.rating] * (Math.random() + 0.5);
      return score > top.score ? { name: p.name, score } : top;
    }, { name: "", score: 0 });

    document.getElementById("gameResult").innerHTML = `
      <h2>ğŸ“Š æ¨¡æ“¬æ¯”è³½çµæœ</h2>
      <p>ğŸ€ å‹‡å£« ${Math.round(teamScore)} : ${Math.round(oppScore)} ${randomTeam}</p>
      <p>ğŸ– MVPï¼š${mvp.name}</p>
    `;
    lastSimDate = today;
    saveData();
    renderDate();
  }
    function prepareTradeUI() {
    const opp = otherTeams[currentTradeTarget];
    const container = document.getElementById("otherTeam");
    container.innerHTML = `
      <h2>ğŸ’¼ èˆ‡ ${currentTradeTarget} äº¤æ˜“</h2>
      <p>è«‹é¸æ“‡é›™æ–¹æœ€å¤š3ä½çƒå“¡èˆ‡æ˜¯å¦åŠ å…¥é¦–è¼ªç±¤ã€‚</p>
      <div id="tradeArea">
        <div><strong>æˆ‘æ–¹çƒå“¡ï¼š</strong></div>
        ${warriors.map((p, i) => `
          <label><input type="checkbox" class="w-trade" value="${i}"> ${p.name}ï½œ${p.rating}</label><br/>
        `).join("")}
        <label><input type="checkbox" id="myPick"> åŠ å…¥æˆ‘æ–¹é¦–è¼ªç±¤</label>
        <hr/>
        <div><strong>${currentTradeTarget} çƒå“¡ï¼š</strong></div>
        ${opp.map((p, i) => `
          <label><input type="checkbox" class="o-trade" value="${i}"> ${p.name}ï½œ${p.rating}</label><br/>
        `).join("")}
        <label><input type="checkbox" id="theirPick"> è¦æ±‚å°æ–¹é¦–è¼ªç±¤</label>
        <br/><br/>
        <button id="submitTrade">æå‡ºäº¤æ˜“</button>
        <div id="tradeResult"></div>
      </div>
    `;

    document.getElementById("submitTrade").addEventListener("click", () => {
      const mySelected = [...document.querySelectorAll(".w-trade:checked")].map(cb => warriors[cb.value]);
      const theirSelected = [...document.querySelectorAll(".o-trade:checked")].map(cb => opp[cb.value]);

      if (mySelected.length === 0 && theirSelected.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½çƒå“¡ï¼");
      if (mySelected.length > 3 || theirSelected.length > 3) return alert("æœ€å¤š3æ›3ï¼");

      let myValue = mySelected.reduce((sum, p) => sum + ratingMap[p.rating], 0);
      let theirValue = theirSelected.reduce((sum, p) => sum + ratingMap[p.rating], 0);

      if (document.getElementById("myPick").checked) {
        if (firstRoundPicks <= 0) return alert("æ²’æœ‰é¦–è¼ªç±¤å¯äº¤æ˜“ï¼");
        myValue += 4; // è‡ªå®šé¦–è¼ªåƒ¹å€¼
      }
      if (document.getElementById("theirPick").checked) theirValue += 4;

      const diff = myValue - theirValue;
      let msg = "";

      if (diff >= 2) msg = "âŒ å°æ–¹èªç‚ºä½ æå‡ºçš„å¤ªå°‘äº†";
      else if (diff <= -4) msg = "âŒ å°æ–¹è¦ºå¾—ä»–å€‘åƒè™§å¤ªå¤š";
      else {
        msg = "âœ… äº¤æ˜“æˆåŠŸï¼";
        // åŸ·è¡Œäº¤æ˜“
        if (document.getElementById("myPick").checked) firstRoundPicks--;
        if (document.getElementById("theirPick").checked) firstRoundPicks++;

        // ç§»å‹•çƒå“¡
        warriors = warriors.filter(p => !mySelected.includes(p)).concat(theirSelected.map(p => ({ ...p, train: 0 })));
        otherTeams[currentTradeTarget] = opp.filter(p => !theirSelected.includes(p)).concat(mySelected.map(p => ({ ...p })));

        saveData();
        showWarriors();
        renderDate();
      }

      document.getElementById("tradeResult").textContent = msg;
    });
  }
    function showWarriors() {
    const container = document.getElementById("team");
    container.innerHTML = "<h2>ğŸ€ å‹‡å£«é™£å®¹</h2>";
    const trainedTodayCount = warriors.filter(p => p.trainedToday).length;

    warriors.forEach((p, i) => {
      if (!p.trainProgress) p.trainProgress = 0;
      const nextRating = getNextRating(p.rating);
      container.innerHTML += `
        <div class="player">
          <div class="player-info">
            <strong>${p.name}</strong>ï½œ${p.rating}ï½œ${ratingStars(p.rating)}ï½œ$${p.salary}M<br/>
            ${p.trainedToday ? "ğŸ§  å·²è¨“ç·´ï½œ" : ""}
            ğŸ“ˆ è¨“ç·´é€²åº¦ï¼š${p.trainProgress}% ${nextRating ? `(ç›®æ¨™ï¼š${nextRating})` : ""}
          </div>
          <button ${p.trainedToday || trainedTodayCount >= 5 ? "disabled" : ""}>è¨“ç·´</button>
        </div>
      `;
    });

    container.querySelectorAll("button").forEach((btn, i) => {
      btn.addEventListener("click", () => {
        const p = warriors[i];
        if (p.trainedToday || trainedTodayCount >= 5) return;
        p.trainedToday = true;
        p.trainProgress = Math.min(100, p.trainProgress + Math.floor(Math.random() * 20 + 10));

        let msg = `${p.name} å®Œæˆè¨“ç·´ï¼ï¼ˆç›®å‰ ${p.trainProgress}%ï¼‰`;
        if (p.trainProgress >= 100) {
          const upgraded = tryUpgrade(p);
          msg += upgraded ? `ğŸ‰ æˆåŠŸå‡ç´šç‚º ${p.rating}ï¼` : `ğŸ˜… æ²’æœ‰å‡ç´šï¼Œç¹¼çºŒåŠªåŠ›ï¼`;
          p.trainProgress = 0;
        }

        alert(msg);
        saveData();
        showWarriors();
      });
    });
  }

  function getNextRating(rating) {
    const order = ["C", "C+", "B-", "B", "B+", "A-", "A", "A+", "S", "S+"];
    const idx = order.indexOf(rating);
    return idx >= 0 && idx < order.length - 1 ? order[idx + 1] : null;
  }

  function tryUpgrade(player) {
    const next = getNextRating(player.rating);
    if (!next) return false;
    const chance = Math.random();
    if (chance < 0.3) {
      player.rating = next;
      return true;
    }
    return false;
  }

  function resetTraining() {
    warriors.forEach(p => p.trainedToday = false);
    alert("æ‰€æœ‰çƒå“¡è¨“ç·´ç‹€æ…‹å·²é‡ç½®ï¼ˆæ¯æ—¥è‡ªå‹•é€²è¡Œï¼‰ï¼");
    saveData();
    showWarriors();
  }

  // è‡ªå‹•æ¯æ—¥é‡ç½®
  setInterval(() => {
    const now = new Date().toDateString();
    if (lastSimDate !== now) {
      warriors.forEach(p => p.trainedToday = false);
      lastSimDate = now;
      saveData();
      renderDate();
      showWarriors();
    }
  }, 10000); // æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼ˆå¯æ”¹æˆæ›´ä¹…ï¼‰
   function showTradeUI() {
    const teamNames = Object.keys(otherTeams);
    const tradeArea = document.getElementById("otherTeam");
    tradeArea.innerHTML = "<h2>ğŸ”„ äº¤æ˜“ä¸­å¿ƒ</h2>";

    let selectedTeam = null;
    let selectedMy = [], selectedTheir = [];

    // é¸æ“‡éšŠä¼
    tradeArea.innerHTML += "<p>é¸æ“‡äº¤æ˜“å°è±¡ï¼š</p>" + teamNames.map(name => `<button>${name}</button>`).join("");

    tradeArea.querySelectorAll("button").forEach((btn, idx) => {
      btn.addEventListener("click", () => {
        selectedTeam = teamNames[idx];
        renderTradeSelection(selectedTeam);
      });
    });

    function renderTradeSelection(teamName) {
      const theirPlayers = otherTeams[teamName];
      tradeArea.innerHTML = `<h2>ğŸ” èˆ‡ ${teamName} é€²è¡Œäº¤æ˜“</h2>`;

      tradeArea.innerHTML += "<h3>ğŸ’› æˆ‘æ–¹å‡ºè®“çƒå“¡</h3>" + warriors.map((p, i) => `
        <div class="player">
          <div class="player-info">${p.name}ï½œ${p.rating}ï½œ$${p.salary}M</div>
          <input type="checkbox" data-type="my" data-index="${i}">
        </div>
      `).join("");

      tradeArea.innerHTML += "<h3>ğŸ’™ å°æ–¹çƒå“¡</h3>" + theirPlayers.map((p, i) => `
        <div class="player">
          <div class="player-info">${p.name}ï½œ${p.rating}ï½œ$${p.salary}M</div>
          <input type="checkbox" data-type="their" data-index="${i}">
        </div>
      `).join("");

      tradeArea.innerHTML += `<button id="confirmTradeBtn">âœ… ç¢ºèªäº¤æ˜“</button>`;

      tradeArea.querySelectorAll("input").forEach(input => {
        input.addEventListener("change", () => {
          const type = input.dataset.type;
          const index = parseInt(input.dataset.index);
          if (type === "my") {
            selectedMy = Array.from(tradeArea.querySelectorAll('input[data-type="my"]:checked')).map(i => parseInt(i.dataset.index));
          } else {
            selectedTheir = Array.from(tradeArea.querySelectorAll('input[data-type="their"]:checked')).map(i => parseInt(i.dataset.index));
          }
        });
      });

      tradeArea.querySelector("#confirmTradeBtn").addEventListener("click", () => {
        if (selectedMy.length === 0 && selectedTheir.length === 0) return alert("è«‹é¸æ“‡è‡³å°‘ä¸€ä½çƒå“¡ã€‚");
        if (selectedMy.length > 3 || selectedTheir.length > 3) return alert("æœ€å¤šåªèƒ½ 3 æ› 3ã€‚");

        const myTotal = selectedMy.reduce((sum, i) => sum + warriors[i].salary, 0);
        const theirTotal = selectedTheir.reduce((sum, i) => sum + theirPlayers[i].salary, 0);
        if (Math.abs(myTotal - theirTotal) > 20) {
          return alert("è–ªè³‡å·®è·éå¤§ï¼Œäº¤æ˜“è¢«æ‹’çµ•ï¼");
        }

        const myTraded = selectedMy.map(i => warriors[i]);
        const theirTraded = selectedTheir.map(i => theirPlayers[i]);

        // åŸ·è¡Œäº¤æ˜“
        warriors = warriors.filter((_, i) => !selectedMy.includes(i)).concat(theirTraded.map(p => ({ ...p, trainedToday: false })));
        otherTeams[teamName] = theirPlayers.filter((_, i) => !selectedTheir.includes(i)).concat(myTraded);

        alert("âœ… äº¤æ˜“æˆåŠŸï¼");
        saveData();
        showWarriors();
        renderDate();
        showTradeUI();
      });
    }
  }

  // æ¯æ—¥è‡ªå‹•é‡ç½®åŠŸèƒ½
  function dailyAutoUpdate() {
    const today = new Date().toDateString();
    const storedDate = localStorage.getItem("sj_last_date");
    if (storedDate !== today) {
      warriors.forEach(p => p.trainedToday = false);
      localStorage.setItem("sj_last_date", today);
      console.log("ğŸ“† è¨“ç·´å·²è‡ªå‹•é‡ç½®ï¼");
    }
  }

  // åˆå§‹åŒ–èˆ‡ç¶å®š
  document.addEventListener("DOMContentLoaded", () => {
    loadData();
    dailyAutoUpdate();
    renderDate();
    showWarriors();

    document.getElementById("showWarriorsBtn").addEventListener("click", showWarriors);
    document.getElementById("showFreeAgentsBtn").addEventListener("click", showFreeAgents);
    document.getElementById("selectTeamBtn").addEventListener("click", showOtherTeams);
    document.getElementById("simulateGameBtn").addEventListener("click", simulateGame);
    document.getElementById("resetTrainingBtn").addEventListener("click", resetTraining);
    document.getElementById("clearBtn").addEventListener("click", () => {
      if (confirm("âŒ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰é€²åº¦ï¼Ÿ")) {
        localStorage.removeItem("sj_gm_data");
        localStorage.removeItem("sj_last_date");
        location.reload();
      }
    });

    // é¡å¤–ï¼šç¶å®šäº¤æ˜“ä¸­å¿ƒå…¥å£ï¼ˆä½ å¯ä»¥åŠ æŒ‰éˆ•è§¸ç™¼ï¼‰
    const tradeBtn = document.createElement("button");
    tradeBtn.textContent = "äº¤æ˜“ä¸­å¿ƒ";
    tradeBtn.onclick = showTradeUI;
    document.querySelector(".section").appendChild(tradeBtn);
  });
})();
    </script>
  </div>
</body>
</html>
